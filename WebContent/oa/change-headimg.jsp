<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="s" uri="/struts-tags" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

	<div class="tab-pane">

		<div class="portlet box blue ">

			<div class="portlet-title">

				<div class="caption"><i class="icon-reorder">
				</i>修改头像</div>
				
			</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     

			<div class="portlet-body row-fluid form">
				
				<div class="span4">
					<h2 style="color:gray;">当前头像</h2>
					<label style="color:gray;font-size: 12px;">
						您当前正在使用的头像。
					</label>
					<img class="thumbnail" id="headImg" alt="我的头像" src="${session.user.head }" style="width: 200px;height: 200px;">
					
				</div>
				
				<div class="span8">
					<h2 style="color:gray;">设置新头像</h2>
					<label style="color:gray;font-size: 12px;">
						支持的格式有：jpg/jpeg/png;
						文件最大为3MB;
					</label>
					<div class="fileupload fileupload-new" data-provides="fileupload"><input type="hidden">
						<div>
							<span class="btn btn-file">
								<span class="fileupload-new">选择图片</span>
								<span class="fileupload-exists">选择图片</span>
								<input  onclick="reChooose();" class="default" type="file" id="headimg_fileUpload" name="file">
							</span>
						</div>
						<br>
						<div class="fileupload-new thumbnail" style="width: 200px; height: 200px;">
							<img src="/upload/headimage/defaultHead.jpg" alt="头像">
						</div>

						<div onmouseover="jiancai();" id="change_head_timg_div" class="fileupload-preview fileupload-exists thumbnail" style="max-width: 500px; max-height: 400px; line-height: 20px;">
						
						</div>
						<div id="imgParam">
							<input type="hidden" id="x1" name="img.x1" value="0" />
						    <input type="hidden" id="y1" name="img.y1" value="0" />
						    <input type="hidden" id="x2" name="img.x2" value="0" />
						    <input type="hidden" id="y2" name="img.y2" value="0" />
						    <input type="hidden" id="h" name="img.h" value="0" />
						    <input type="hidden" id="w" name="img.w" value="0" />
						</div>

					</div>
					<button class="btn green" onclick="changeHead();"><i class="icon-ok"></i> 确认修改</button>
				</div>
			</div>

		</div>

	</div>

	<script>
	
		 var imgSelect;
		 
		 function jiancai(){
			if(imgSelect != null){
				return false;
			}
			imgjQueryObject = $('#change_head_timg_div img').eq(0);
			//获取图片真实长宽
			var img = new Image();
			img.src =imgjQueryObject.attr("src") ;
			var w = img.width;
			var h = img.height;
			//创建剪裁区域
			imgSelect = imgjQueryObject.imgAreaSelect({ 
				
						    	aspectRatio: '1:1', 					//宽高比
						        fadeSpeed: 200,					//加载淡入
						        imageHeight:h,						//图片实际高度
						        imageWidth:w,						//图片实际宽度
						        x1:w == h ? 0 : (w > h ? (w-h)/2 : 0),			//初始x1
						        y1:w == h ? 0 : (w>h ? 0 : (h-w)/2),				//初始y1
						        x2:w == h ? w : (w>h ? (w-h)/2+h : w),			//初始x2
						        y2:w == h ? h : (w>h ? h : (h-w)/2+w),			//初始y2
						        instance:true,						//是否生成控制对象
						        onSelectChange: preview			//当选择时触发的方法。
						    });
		
	}
	
	//剪裁图片时的操作。
	function preview(img, selection) {
	    if (!selection.width || !selection.height)
	        return;
	    $('#x1').val(selection.x1);
	    $('#y1').val(selection.y1);
	    $('#x2').val(selection.x2);
	    $('#y2').val(selection.y2);
	    $('#w').val(selection.width);
	    $('#h').val(selection.height);    
	}
	
	function getPreview(){
		if(imgSelect == undefined){
			return false;
		}
		var selection = imgSelect.getSelection();
		if(selection.width == 0 || selection.height == 0){
			return false;
		}
		$('#x1').val(selection.x1);
	    $('#y1').val(selection.y1);
	    $('#x2').val(selection.x2);
	    $('#y2').val(selection.y2);
	    $('#w').val(selection.width);
	    $('#h').val(selection.height);    
	    return true;
	}
	
	function reChooose(){
		
		if(imgSelect != undefined){
			imgSelect.cancelSelection();
			imgSelect = undefined;
		}
		
	}
	
	//提交图片以及剪裁信息；
	function changeHead(){
		if(!getPreview()){
			tools.tip("请选择剪裁范围！");
			return false;
		}
		var params = tools.formParams("imgParam");
		  $.ajaxFileUpload({
            url:'head_admin',            						 //需要链接到服务器地址
            data:params,											 //参数
            secureuri:false,										 //是否启用安全提交，默认为false
            fileElementId:'headimg_fileUpload',        //文件选择框的id属性
            dataType: 'json',                                    //服务器返回的格式，可以是json
            success: function (data, status){     
          	  if(data.success){
          		  tools.tip("修改成功！",function(){
          			reChooose();
          			 tools.loadAction("findToJson_admin", {
          				 "data.id" : "${session.user.id}"
          			 }, function(data){
          				 //导航头像
          				 $("#nvrHeadImg").attr("src",data.head);
          				reLoadTab("#module=admin-show&action=find_admin&data.id=${session.user.id}","个人资料");
          			 });
          		  });
          		  
          	  }else{
          		  var _case = {1:"请选择文件！",
		      			  			2:"选择的文件类型不正确！",
		      			  			3:"文件大小超过限制！",
		      			  			4:"请选择裁剪范围！"};
          		  tools.adminErrorTip(_case,data.code);
          	  }
            },
            error: function (data, status, e){
            	nowDiv.html(data.responseText);
            }
        });
          
	}
	</script>



	
	